<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebApp Report Visite</title>
    
    <!-- ICONE PER LA HOME SCREEN -->
    <link rel="icon" href="Logo CERVE WebApp.jpg">
    <link rel="apple-touch-icon" href="Logo CERVE WebApp.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SCRIPT SCANNER CORRETTO (integrity, non xintegrity) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" xintegrity="sha512-rVFjOMM/c9f3MUPRguCInK7mS2jK0gG4Nq23rTf+vH/cNM/QnkhOEd1T8j1i/M2vG/vPjI31Zk+L8nL23rA2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-focus:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        #confirmation-modal.hidden, #qr-scanner-modal.hidden, #preview-box.hidden {
            display: none;
        }
        .input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px #fecaca;
        }
        #qr-reader {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 4px solid #3b82f6;
        }
        /* Stili per i pulsanti di esportazione raggruppati */
        .export-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 768px) { /* md: */
            .export-group {
                grid-template-columns: 1fr 1fr;
            }
            .export-group-full {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        /* Stile per l'anteprima testuale */
        #preview-content {
            white-space: pre-wrap; /* Manda a capo il testo */
            word-wrap: break-word; /* Rompe parole lunghe */
            font-family: Consolas, 'Courier New', monospace; /* Font leggibile */
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">Nuovo Report Visita</h1>
                <p id="page-indicator" class="text-gray-500 mt-2 font-medium">Pagina 1 di 3: Dati Azienda</p>
            </div>

            <form id="report-form" class="space-y-6">
                <!-- Pagina 1: Dati Azienda -->
                <div id="page1" class="page active">
                    <div class="mb-6">
                        <button type="button" id="btn-scan-qr" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">
                            Scansiona QR Code
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="company-name" class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-state" class="block text-sm font-medium text-gray-600 mb-1">Stato/Regione</label>
                            <input type="text" id="company-state" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-city" class="block text-sm font-medium text-gray-600 mb-1">Città</label>
                            <input type="text" id="company-city" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div class="md:col-span-2">
                            <label for="company-address" class="block text-sm font-medium text-gray-600 mb-1">Indirizzo</label>
                            <input type="text" id="company-address" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        
                        <!-- Campi con Datalist -->
                        <div>
                            <label for="division" class="block text-sm font-medium text-gray-600 mb-1">Divisione</label>
                            <input list="division-list" id="division" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="division-list">
                                <option value="VidiVi Italia"></option>
                                <option value="VidiVi Estero"></option>
                                <option value="Casalingo Italia"></option>
                                <option value="Casalingo Estero"></option>
                                <option value="B2B Italia"></option>
                                <option value="B2B Estero"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="sector" class="block text-sm font-medium text-gray-600 mb-1">Settore</label>
                            <input list="sector-list" id="sector" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="sector-list">
                                <option value="Vario"></option>
                                <option value="Soft Drinks"></option>
                                <option value="Cantina"></option>
                                <option value="Birreria"></option>
                                <option value="Bar"></option>
                                <option value="Distilleria"></option>
                                <option value="Gelateria"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="typology" class="block text-sm font-medium text-gray-600 mb-1">Tipologia</label>
                            <input list="typology-list" id="typology" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="typology-list">
                                <option value="GDS"></option>
                                <option value="GDO"></option>
                                <option value="Dettaglio"></option>
                                <option value="Promozioni Aziendali"></option>
                                <option value="Grossista"></option>
                                <option value="Ho.Re.Ca."></option>
                                <option value="E-commerce"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="competitors" class="block text-sm font-medium text-gray-600 mb-1">Concorrenti Citati</label>
                            <input type="text" id="competitors" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         <div>
                            <label for="price-sensitivity" class="block text-sm font-medium text-gray-600 mb-1">Sensibilità al Prezzo</label>
                            <input list="price-sensitivity-list" id="price-sensitivity" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="price-sensitivity-list">
                                <option value="Alta"></option>
                                <option value="Media"></option>
                                <option value="Bassa"></option>
                            </datalist>
                        </div>
                         <div>
                            <label for="expected-volume" class="block text-sm font-medium text-gray-600 mb-1">Volumi Attesi</label>
                            <input list="expected-volume-list" id="expected-volume" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="expected-volume-list">
                                <option value="Alti"></option>
                                <option value="Medi"></option>
                                <option value="Bassi"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 2: Dati Contatto -->
                <div id="page2" class="page">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contact-name" class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="contact-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-surname" class="block text-sm font-medium text-gray-600 mb-1">Cognome</label>
                            <input type="text" id="contact-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-phone" class="block text-sm font-medium text-gray-600 mb-1">Telefono</label>
                            <input type="tel" id="contact-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-email" class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                            <input type="email" id="contact-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-role" class="block text-sm font-medium text-gray-600 mb-1">Ruolo</label>
                            <input type="text" id="contact-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="meeting-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo di Incontro</label>
                            <input list="meeting-type-list" id="meeting-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="meeting-type-list">
                                <option value="Visita"></option>
                                <option value="Chiamata"></option>
                                <option value="Email"></option>
                                <option value="Fiera"></option>
                                <option value="Evento"></option>
                            </datalist>
                        </div>
                        <div class="md:col-span-2">
                            <label for="meeting-subject" class="block text-sm font-medium text-gray-600 mb-1">Oggetto Incontro</label>
                            <input type="text" id="meeting-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Data Incontro</to>
                            <input type="date" id="meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="next-meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Prossimo Incontro</label>
                            <input type="date" id="next-meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         <div class="md:col-span-2">
                            <label for="decision" class="block text-sm font-medium text-gray-600 mb-1">Decisione</label>
                            <input list="decision-list" id="decision" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="decision-list">
                                <option value="In Attesa"></option>
                                <option value="Follow-Up"></option>
                                <option value="Online Immediato"></option>
                                <option value="Opportunità"></option>
                                <option value="Richiede Campionatura"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 3: Note e Cognome Agente -->
                <div id="page3" class="page">
                    <div class="space-y-6">
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-600 mb-1">Note</label>
                            <textarea id="notes" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Aggiungi qui le tue note strategiche..."></textarea>
                        </div>
                        <div>
                            <label for="agent-name" class="block text-sm font-medium text-gray-600 mb-1">Cognome Referente Commerciale</label>
                            <input type="text" id="agent-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Es. Rossi">
                        </div>
                    </div>
                </div>
            </form>

            <!-- Navigazione -->
            <div class="pt-6 border-t mt-6 flex justify-between items-center">
                <button id="btn-prev" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all shadow-md">Indietro</button>
                <button id="btn-next" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">Avanti</button>
            </div>
        </main>
        
        <!-- SEZIONE ANTEPRIMA "SEMPLICE" (nascosta) -->
        <div id="preview-box" class="mt-8 bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Anteprima Dati</h2>
                <button id="btn-close-preview" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
            </div>
            <!-- Usiamo <pre> per mostrare i dati formattati in modo leggibile -->
            <pre id="preview-content" class="bg-gray-100 p-4 rounded-lg overflow-x-auto" style="max-height: 400px;"></pre>
        </div>

        <!-- Sezione Esportazione -->
        <div id="export-section" class="mt-8 bg-white rounded-xl shadow-lg p-6 text-center">
            <div id="feedback-message" class="mb-4 text-green-700 font-medium"></div>
            <p class="text-lg text-gray-800 mb-4">
                Hai <strong id="visit-count" class="text-blue-600">0</strong> visite salvate sul dispositivo.
            </p>
            
            <div class="export-group export-group-full">
                <button id="preview-data" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Vedi Anteprima
                </button>
                <button id="export-csv" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Esporta in CSV
                </button>
                <button id="clear-data" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Svuota Dati
                </button>
            </div>
        </div>
    </div>

    <!-- Modale di Conferma Eliminazione -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Conferma Eliminazione</h3>
            <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare <strong id="modal-visit-count">0</strong> visite salvate? L'operazione non è reversibile.</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-btn-cancel" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all">Annulla</button>
                <button id="modal-btn-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all">Conferma ed Elimina</button>
            </div>
        </div>
    </div>

    <!-- Modale Scanner QR -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Inquadra il QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <p id="qr-scan-feedback" class="text-center text-gray-600 mt-4"></p>
        </div>
        <button id="modal-btn-close-qr" class="bg-white text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-200 transition-all mt-6 shadow-lg">Chiudi Scanner</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Riferimenti agli elementi
        const reportForm = document.getElementById('report-form');
        const pageIndicator = document.getElementById('page-indicator');
        const pages = document.querySelectorAll('.page');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const exportButton = document.getElementById('export-csv');
        const clearButton = document.getElementById('clear-data');
        const visitCountSpan = document.getElementById('visit-count');
        const feedbackMessage = document.getElementById('feedback-message');
        
        // Modale eliminazione
        const modal = document.getElementById('confirmation-modal');
        const modalVisitCount = document.getElementById('modal-visit-count');
        const modalBtnCancel = document.getElementById('modal-btn-cancel');
        const modalBtnConfirm = document.getElementById('modal-btn-confirm');
        
        // Input obbligatori
        const companyNameInput = document.getElementById('company-name');
        const agentNameInput = document.getElementById('agent-name');

        // Scanner QR
        const btnScanQr = document.getElementById('btn-scan-qr');
        const qrModal = document.getElementById('qr-scanner-modal');
        const qrReaderDiv = document.getElementById('qr-reader');
        const qrScanFeedback = document.getElementById('qr-scan-feedback');
        const btnCloseQr = document.getElementById('modal-btn-close-qr');
        let html5QrCode = null;

        // RIFERIMENTI ANTEPRIMA
        const previewButton = document.getElementById('preview-data');
        const previewBox = document.getElementById('preview-box');
        const previewContent = document.getElementById('preview-content');
        const btnClosePreview = document.getElementById('btn-close-preview');

        // Mappatura campi
        const fields = {
            companyName: document.getElementById('company-name'),
            companyState: document.getElementById('company-state'),
            companyCity: document.getElementById('company-city'),
            companyAddress: document.getElementById('company-address'),
            division: document.getElementById('division'),
            sector: document.getElementById('sector'),
            typology: document.getElementById('typology'),
            competitors: document.getElementById('competitors'),
            priceSensitivity: document.getElementById('price-sensitivity'),
            expectedVolume: document.getElementById('expected-volume'),
            contactName: document.getElementById('contact-name'),
            contactSurname: document.getElementById('contact-surname'),
            contactPhone: document.getElementById('contact-phone'),
            contactEmail: document.getElementById('contact-email'),
            contactRole: document.getElementById('contact-role'),
            meetingType: document.getElementById('meeting-type'),
            meetingSubject: document.getElementById('meeting-subject'),
            meetingDate: document.getElementById('meeting-date'),
            nextMeetingDate: document.getElementById('next-meeting-date'),
            decision: document.getElementById('decision'),
            notes: document.getElementById('notes'),
            agentName: document.getElementById('agent-name')
        };
        
        // Dizionario per tradurre le chiavi in etichette leggibili
        const fieldLabels = {
            timestamp: 'Data Registrazione',
            agentName: 'Cognome Referente Commerciale',
            companyName: 'Nome Azienda',
            companyState: 'Stato/Regione',
            companyCity: 'Città',
            companyAddress: 'Indirizzo',
            division: 'Divisione',
            sector: 'Settore',
            typology: 'Tipologia',
            competitors: 'Concorrenti Citati',
            priceSensitivity: 'Sensibilità Prezzo',
            expectedVolume: 'Volumi Attesi',
            contactName: 'Nome Contatto',
            contactSurname: 'Cognome Contatto',
            contactPhone: 'Telefono Contatto',
            contactEmail: 'Email Contatto',
            contactRole: 'Ruolo Contatto',
            meetingType: 'Tipo Incontro',
            meetingSubject: 'Oggetto Incontro',
            meetingDate: 'Data Incontro',
            nextMeetingDate: 'Prossimo Incontro',
            decision: 'Decisione',
            notes: 'Note'
        };

        let currentPage = 1;
        let allVisits = [];
        const pageTitles = ["Dati Azienda", "Dati Contatto", "Note e Agente"];
        
        // --- Gestione Storage ---
        const loadVisitsFromLocalStorage = () => {
            try {
                const storedVisits = localStorage.getItem('salesReportVisits');
                if (storedVisits) {
                    allVisits = JSON.parse(storedVisits);
                }
            } catch (e) {
                console.error("Errore nel caricare le visite:", e);
                allVisits = [];
            }
        };

        const saveVisitsToLocalStorage = () => {
            try {
                localStorage.setItem('salesReportVisits', JSON.stringify(allVisits));
            } catch (e) {
                console.error("Errore nel salvare le visite:", e);
                feedbackMessage.textContent = "Errore: impossibile salvare i dati.";
            }
        };

        // --- Funzione Utility per Feedback Visivo Errore ---
        const showInputError = (inputElement, message) => {
            inputElement.classList.add('input-error');
            const originalPlaceholder = inputElement.placeholder;
            inputElement.placeholder = message;
            
            inputElement.addEventListener('input', () => {
                inputElement.classList.remove('input-error');
                inputElement.placeholder = originalPlaceholder;
            }, { once: true });
        };
        
        // --- Aggiornamento UI ---
        const updateUI = () => {
            const count = allVisits.length;
            visitCountSpan.textContent = count;
            exportButton.disabled = count === 0;
            clearButton.disabled = count === 0;
            previewButton.disabled = count === 0;
            showPage(currentPage);
        };

        const showPage = (pageNumber) => {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page${pageNumber}`).classList.add('active');
            
            pageIndicator.textContent = `Pagina ${pageNumber} di 3: ${pageTitles[pageNumber - 1]}`;

            btnPrev.style.visibility = (pageNumber === 1) ? 'hidden' : 'visible';
            
            if (pageNumber === 3) {
                btnNext.textContent = 'Salva Visita';
                btnNext.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnNext.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btnNext.textContent = 'Avanti';
                btnNext.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnNext.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        };
        
        // --- Navigazione Pagine e Validazione ---
        btnPrev.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });
        
        btnNext.addEventListener('click', () => {
            if (currentPage === 1 && companyNameInput.value.trim() === '') {
                showInputError(companyNameInput, 'Il campo Nome è obbligatorio');
                return;
            }

            if (currentPage < 3) {
                currentPage++;
                showPage(currentPage);
            } else {
                if (agentNameInput.value.trim() === '') {
                    showInputError(agentNameInput, 'Cognome Referente è obbligatorio');
                    return;
                }
                saveVisit();
            }
        });

        // --- Logica di Salvataggio ---
        const saveVisit = () => {
            const visitData = {};
            for (const key in fields) {
                if (fields[key]) {
                    // Gestisce i campi data che non devono essere 'trimmati'
                    if (fields[key].type === 'date') {
                        visitData[key] = fields[key].value;
                    } else {
                        visitData[key] = fields[key].value.trim();
                    }
                }
            }
            visitData.timestamp = new Date().toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'short' });
            
            allVisits.push(visitData);
            saveVisitsToLocalStorage();
            
            feedbackMessage.textContent = `Report per "${visitData.companyName}" salvato!`;
            setTimeout(() => feedbackMessage.textContent = '', 4000);
            
            reportForm.reset();
            currentPage = 1;
            updateUI();
        };

        // --- Logica Esportazione CSV ---
        const escapeCSV = (field) => {
            if (field === null || field === undefined) return '';
            let str = String(field);
            // Pulisce le date per evitare formattazioni strane
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Converte YYYY-MM-DD in DD/MM/YYYY per leggibilità in Excel
                const [y, m, d] = str.split('-');
                return `${d}/${m}/${y}`;
            }
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        };

        exportButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            // Usa le etichette leggibili come intestazioni
            const headers = Object.values(fieldLabels);
            
            const csvRows = [headers.join(',')];
            
            allVisits.forEach(v => {
                // Mappa i dati nell'ordine delle etichette
                const row = Object.keys(fieldLabels).map(key => escapeCSV(v[key]));
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute('href', url);
            link.setAttribute('download', `report-visite-${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Logica Svuota Dati ---
        clearButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            modalVisitCount.textContent = allVisits.length;
            modal.classList.remove('hidden');
        });
        
        modalBtnCancel.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        modalBtnConfirm.addEventListener('click', () => {
            allVisits = [];
            saveVisitsToLocalStorage();
            updateUI();
            modal.classList.add('hidden');
            feedbackMessage.textContent = 'Dati locali eliminati con successo.';
            setTimeout(() => feedbackMessage.textContent = '', 4000);
        });

        // --- Logica Scanner QR ---
        const stopQrScanner = () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.warn("Errore durante lo stop dello scanner QR:", err));
            }
            qrModal.classList.add('hidden');
            qrScanFeedback.textContent = '';
        };

        btnScanQr.addEventListener('click', () => {
            qrModal.classList.remove('hidden');
            if (!html5QrCode) {
                try {
                    html5QrCode = new Html5Qrcode("qr-reader");
                } catch (e) {
                    console.error("Impossibile inizializzare Html5Qrcode:", e);
                    qrScanFeedback.textContent = "Errore inizializzazione scanner.";
                    return;
                }
            }
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    // Prova a trovare la fotocamera posteriore
                    const cameraId = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('posteriore'))?.id || devices[0].id;
                    html5QrCode.start(
                        cameraId, 
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        onScanSuccess,
                        onScanFailure
                    ).catch(err => {
                        console.error("Impossibile avviare lo scanner:", err);
                        qrScanFeedback.textContent = "Impossibile avviare la fotocamera.";
                    });
                }
            }).catch(err => {
                console.error("Errore nel trovare fotocamere:", err);
                qrScanFeedback.textContent = "Nessuna fotocamera trovata.";
            });
        });
        
        btnCloseQr.addEventListener('click', stopQrScanner);

        const onScanSuccess = (decodedText, decodedResult) => {
            qrScanFeedback.textContent = "Scansione riuscita! Analisi dati...";
            const success = parseVCard(decodedText) || parseJSON(decodedText);
            if (success) {
                feedbackMessage.textContent = "Dati QR importati con successo!";
            } else {
                // Fallback: copia nelle note
                fields.notes.value = (fields.notes.value ? fields.notes.value + '\n\n' : '') + '--- DATI DA QR CODE ---\n' + decodedText;
                feedbackMessage.textContent = "Testo QR copiato nelle Note!";
                currentPage = 3; // Vai direttamente alla pagina 3
                showPage(3);
            }
            stopQrScanner();
            setTimeout(() => feedbackMessage.textContent = '', 4000);
        };
        
        const onScanFailure = (error) => {
            // Non fare nulla in caso di fallimento (continua a scansionare)
        };

        const parseVCard = (text) => {
            if (!text.startsWith('BEGIN:VCARD')) return false;
            let vCardData = {};
            text.split('\n').forEach(line => {
                if (line.includes(':')) {
                    let [key, ...value] = line.split(':');
                    value = value.join(':').replace(/\\,/g, ',').replace(/\\n/g, '\n'); // Pulisce i valori
                    key = key.split(';')[0].trim().toUpperCase(); // Normalizza la chiave
                    vCardData[key] = value.trim();
                }
            });
            if (vCardData.ORG) fields.companyName.value = vCardData.ORG;
            if (vCardData.ADR) {
                const parts = vCardData.ADR.split(';');
                if (parts[2]) fields.companyAddress.value = parts[2];
                if (parts[3]) fields.companyCity.value = parts[3];
                if (parts[4]) fields.companyState.value = parts[4];
            }
            if (vCardData.N) {
                const [surname, name] = vCardData.N.split(';');
                fields.contactSurname.value = surname || '';
                fields.contactName.value = name || '';
            } else if (vCardData.FN) { // Fallback su Full Name
                const nameParts = vCardData.FN.split(' ');
                fields.contactName.value = nameParts[0];
                fields.contactSurname.value = nameParts.slice(1).join(' ');
            }
            if (vCardData.TEL) fields.contactPhone.value = vCardData.TEL;
            if (vCardData.EMAIL) fields.contactEmail.value = vCardData.EMAIL;
            if (vCardData.TITLE) fields.contactRole.value = vCardData.TITLE;
            return true;
        };
        
        const parseJSON = (text) => {
            try {
                const data = JSON.parse(text);
                // Cerca chiavi comuni (anche in minuscolo)
                const lowerData = {};
                for (const key in data) {
                    lowerData[key.toLowerCase()] = data[key];
                }
                
                fields.companyName.value = lowerData.company || lowerData.azienda || lowerData.org || fields.companyName.value;
                fields.contactName.value = lowerData.name || lowerData.nome || lowerData.firstname || fields.contactName.value;
                fields.contactSurname.value = lowerData.surname || lowerData.cognome || lowerData.lastname || fields.contactSurname.value;
                fields.contactEmail.value = lowerData.email || lowerData.mail || fields.contactEmail.value;
                fields.contactPhone.value = lowerData.phone || lowerData.telefono || lowerData.tel || fields.contactPhone.value;
                fields.contactRole.value = lowerData.role || lowerData.ruolo || lowerData.title || fields.contactRole.value;
                fields.companyAddress.value = lowerData.address || lowerData.indirizzo || fields.companyAddress.value;
                fields.companyCity.value = lowerData.city || lowerData.citta || fields.companyCity.value;
                fields.companyState.value = lowerData.state || lowerData.regione || fields.companyState.value;
                return true;
            } catch (e) {
                return false; // Non era JSON valido
            }
        };

        // --- LOGICA ANTEPRIMA "SEMPLICE" ---
        previewButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            
            let previewText = '';
            
            allVisits.forEach((visit, index) => {
                previewText += `--- VISITA ${index + 1} / ${allVisits.length} ---\n`;
                
                // Itera usando il dizionario per mantenere l'ordine
                for (const key in fieldLabels) {
                    const label = fieldLabels[key];
                    let value = visit[key];
                    
                    // Formatta le date
                    if (key === 'meetingDate' || key === 'nextMeetingDate') {
                        if (value) {
                            const [y, m, d] = value.split('-');
                            value = `${d}/${m}/${y}`;
                        }
                    }
                    
                    if (value !== undefined && value !== null && value !== '') {
                        previewText += `${label}: ${value}\n`;
                    }
                }
                previewText += `\n`; // Spazio tra una visita e l'altra
            });
            
            previewContent.textContent = previewText;
            
            previewBox.classList.remove('hidden');
            // Porta l'utente a vedere l'anteprima
            previewBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        btnClosePreview.addEventListener('click', () => {
            previewBox.classList.add('hidden');
            previewContent.textContent = '';
        });

        // --- Inizializzazione ---
        loadVisitsFromLocalStorage();
        updateUI();
    });
    </script>
</body>
</html>
