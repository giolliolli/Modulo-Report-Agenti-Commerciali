<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebApp Report Visite</title>
    
    <!-- ICONE PER LA HOME SCREEN -->
    <link rel="icon" href="Logo CERVE WebApp.jpg">
    <link rel="apple-touch-icon" href="Logo CERVE WebApp.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" xintegrity="sha512-rVFjOMM/c9f3MUPRguCInK7mS2jK0gG4Nq23rTf+vH/cNM/QnkhOEd1T8j1i/M2vG/vPjI31Zk+L8nL23rA2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-focus:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        #confirmation-modal.hidden, #qr-scanner-modal.hidden, #preview-box.hidden {
            display: none;
        }
        .input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px #fecaca;
        }
        #qr-reader {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 4px solid #3b82f6;
        }
        .export-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .export-group {
                grid-template-columns: 1fr 1fr;
            }
            .export-group-full {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        #preview-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: Consolas, 'Courier New', monospace;
            line-height: 1.6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">Nuovo Report Visita</h1>
                <p id="page-indicator" class="text-gray-500 mt-2 font-medium">Pagina 1 di 3: Dati Azienda</p>
            </div>

            <form id="report-form" class="space-y-6">
                <!-- Pagina 1: Dati Azienda -->
                <div id="page1" class="page active">
                    <div class="mb-6">
                        <button type="button" id="btn-scan-qr" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">
                            Scansiona QR Code
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="company-name" class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-state" class="block text-sm font-medium text-gray-600 mb-1">Stato/Regione</label>
                            <input type="text" id="company-state" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-city" class="block text-sm font-medium text-gray-600 mb-1">Città</label>
                            <input type="text" id="company-city" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div class="md:col-span-2">
                            <label for="company-address" class="block text-sm font-medium text-gray-600 mb-1">Indirizzo</label>
                            <input type="text" id="company-address" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        
                        <!-- Campi con Datalist -->
                        <div>
                            <label for="division" class="block text-sm font-medium text-gray-600 mb-1">Divisione</label>
                            <input list="division-list" id="division" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="division-list">
                                <option value="VidiVi Italia"></option>
                                <option value="VidiVi Estero"></option>
                                <option value="Casalingo Italia"></option>
                                <option value="Casalingo Estero"></option>
                                <option value="B2B Italia"></option>
                                <option value="B2B Estero"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="sector" class="block text-sm font-medium text-gray-600 mb-1">Settore</label>
                            <input list="sector-list" id="sector" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="sector-list">
                                <option value="Vario"></option>
                                <option value="Soft Drinks"></option>
                                <option value="Cantina"></option>
                                <option value="Birreria"></option>
                                <option value="Bar"></option>
                                <option value="Distilleria"></option>
                                <option value="Gelateria"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="typology" class="block text-sm font-medium text-gray-600 mb-1">Tipologia</label>
                            <input list="typology-list" id="typology" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="typology-list">
                                <option value="GDS"></option>
                                <option value="GDO"></option>
                                <option value="Dettaglio"></option>
                                <option value="Promozioni Aziendali"></option>
                                <option value="Grossista"></option>
                                <option value="Ho.Re.Ca."></option>
                                <option value="E-commerce"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="competitors" class="block text-sm font-medium text-gray-600 mb-1">Concorrenti Citati</label>
                            <input type="text" id="competitors" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         <div>
                            <label for="price-sensitivity" class="block text-sm font-medium text-gray-600 mb-1">Sensibilità al Prezzo</label>
                            <input list="price-sensitivity-list" id="price-sensitivity" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="price-sensitivity-list">
                                <option value="Alta"></option>
                                <option value="Media"></option>
                                <option value="Bassa"></option>
                            </datalist>
                        </div>
                         <div>
                            <label for="expected-volume" class="block text-sm font-medium text-gray-600 mb-1">Volumi Attesi</label>
                            <input list="expected-volume-list" id="expected-volume" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="expected-volume-list">
                                <option value="Alti"></option>
                                <option value="Medi"></option>
                                <option value="Bassi"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 2: Dati Contatto (MULTI-CONTATTO) -->
                <div id="page2" class="page">
                    <div class="mb-4 border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Aggiungi Persona Incontrata</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <input type="text" id="contact-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Nome">
                            </div>
                            <div>
                                <input type="text" id="contact-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Cognome">
                            </div>
                            <div>
                                <input type="tel" id="contact-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Telefono">
                            </div>
                            <div>
                                <input type="email" id="contact-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Email">
                            </div>
                            <div class="md:col-span-2">
                                <input type="text" id="contact-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Ruolo">
                            </div>
                        </div>
                        <button type="button" id="btn-add-contact" class="mt-3 w-full bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-all border border-indigo-200">
                            + Aggiungi Contatto alla Lista
                        </button>
                    </div>

                    <!-- LISTA CONTATTI AGGIUNTI -->
                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Contatti Inseriti (<span id="contact-count">0</span>)</h3>
                        <ul id="contacts-list" class="space-y-2">
                            <!-- Qui appariranno i contatti aggiunti -->
                            <li id="no-contacts-msg" class="text-sm text-gray-400 italic">Nessun contatto inserito per questa visita.</li>
                        </ul>
                    </div>

                    <hr class="border-gray-200 my-6">

                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Dettagli Incontro</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="meeting-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo di Incontro</label>
                            <input list="meeting-type-list" id="meeting-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="meeting-type-list">
                                <option value="Visita"></option>
                                <option value="Chiamata"></option>
                                <option value="Email"></option>
                                <option value="Fiera"></option>
                                <option value="Evento"></option>
                            </datalist>
                        </div>
                        <div class="md:col-span-2">
                            <label for="meeting-subject" class="block text-sm font-medium text-gray-600 mb-1">Oggetto Incontro</label>
                            <input type="text" id="meeting-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Data Incontro</label>
                            <input type="date" id="meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="next-meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Prossimo Incontro</label>
                            <input type="date" id="next-meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         <div class="md:col-span-2">
                            <label for="decision" class="block text-sm font-medium text-gray-600 mb-1">Decisione</label>
                            <input list="decision-list" id="decision" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="decision-list">
                                <option value="In Attesa"></option>
                                <option value="Follow-Up"></option>
                                <option value="Online Immediato"></option>
                                <option value="Opportunità"></option>
                                <option value="Richiede Campionatura"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 3: Note e Cognome Agente -->
                <div id="page3" class="page">
                    <div class="space-y-6">
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-600 mb-1">Note</label>
                            <textarea id="notes" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Aggiungi qui le tue note strategiche..."></textarea>
                            <p class="text-xs text-gray-400 mt-1">Gli "a capo" verranno automaticamente formattati per evitare errori nel CSV.</p>
                        </div>
                        <div>
                            <label for="agent-name" class="block text-sm font-medium text-gray-600 mb-1">Cognome Referente Commerciale</label>
                            <input type="text" id="agent-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Es. Rossi">
                        </div>
                    </div>
                </div>
            </form>

            <!-- Navigazione -->
            <div class="pt-6 border-t mt-6 flex justify-between items-center">
                <button id="btn-prev" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all shadow-md">Indietro</button>
                <button id="btn-next" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">Avanti</button>
            </div>
        </main>
        
        <!-- Anteprima -->
        <div id="preview-box" class="mt-8 bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Anteprima Dati</h2>
                <button id="btn-close-preview" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
            </div>
            <pre id="preview-content" class="bg-gray-100 p-4 rounded-lg overflow-x-auto" style="max-height: 400px;"></pre>
        </div>

        <!-- Sezione Esportazione -->
        <div id="export-section" class="mt-8 bg-white rounded-xl shadow-lg p-6 text-center">
            <div id="feedback-message" class="mb-4 text-green-700 font-medium"></div>
            <p class="text-lg text-gray-800 mb-4">
                Hai <strong id="visit-count" class="text-blue-600">0</strong> visite salvate sul dispositivo.
            </p>
            
            <div class="export-group export-group-full">
                <button id="preview-data" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Vedi Anteprima
                </button>
                <button id="export-csv" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Esporta in CSV
                </button>
                <button id="clear-data" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Svuota Dati
                </button>
            </div>
        </div>
    </div>

    <!-- Modale di Conferma Eliminazione -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Conferma Eliminazione</h3>
            <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare <strong id="modal-visit-count">0</strong> visite salvate? L'operazione non è reversibile.</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-btn-cancel" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all">Annulla</button>
                <button id="modal-btn-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all">Conferma ed Elimina</button>
            </div>
        </div>
    </div>

    <!-- Modale Scanner QR -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Inquadra il QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <p id="qr-scan-feedback" class="text-center text-gray-600 mt-4"></p>
        </div>
        <button id="modal-btn-close-qr" class="bg-white text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-200 transition-all mt-6 shadow-lg">Chiudi Scanner</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Riferimenti
        const reportForm = document.getElementById('report-form');
        const pageIndicator = document.getElementById('page-indicator');
        const pages = document.querySelectorAll('.page');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const exportButton = document.getElementById('export-csv');
        const clearButton = document.getElementById('clear-data');
        const visitCountSpan = document.getElementById('visit-count');
        const feedbackMessage = document.getElementById('feedback-message');
        
        // Modale eliminazione
        const modal = document.getElementById('confirmation-modal');
        const modalVisitCount = document.getElementById('modal-visit-count');
        const modalBtnCancel = document.getElementById('modal-btn-cancel');
        const modalBtnConfirm = document.getElementById('modal-btn-confirm');
        
        // Input obbligatori
        const companyNameInput = document.getElementById('company-name');
        const agentNameInput = document.getElementById('agent-name');

        // Scanner QR
        const btnScanQr = document.getElementById('btn-scan-qr');
        const qrModal = document.getElementById('qr-scanner-modal');
        const qrReaderDiv = document.getElementById('qr-reader');
        const qrScanFeedback = document.getElementById('qr-scan-feedback');
        const btnCloseQr = document.getElementById('modal-btn-close-qr');
        let html5QrCode = null;

        // Anteprima
        const previewButton = document.getElementById('preview-data');
        const previewBox = document.getElementById('preview-box');
        const previewContent = document.getElementById('preview-content');
        const btnClosePreview = document.getElementById('btn-close-preview');

        // MULTI CONTATTO
        const btnAddContact = document.getElementById('btn-add-contact');
        const contactsListEl = document.getElementById('contacts-list');
        const noContactsMsg = document.getElementById('no-contacts-msg');
        const contactCountEl = document.getElementById('contact-count');
        
        let currentVisitContacts = []; // Array temporaneo per i contatti della visita attuale

        // Mappatura campi (esclusi contatti singoli)
        const companyFields = {
            companyName: document.getElementById('company-name'),
            companyState: document.getElementById('company-state'),
            companyCity: document.getElementById('company-city'),
            companyAddress: document.getElementById('company-address'),
            division: document.getElementById('division'),
            sector: document.getElementById('sector'),
            typology: document.getElementById('typology'),
            competitors: document.getElementById('competitors'),
            priceSensitivity: document.getElementById('price-sensitivity'),
            expectedVolume: document.getElementById('expected-volume')
        };

        const meetingFields = {
            meetingType: document.getElementById('meeting-type'),
            meetingSubject: document.getElementById('meeting-subject'),
            meetingDate: document.getElementById('meeting-date'),
            nextMeetingDate: document.getElementById('next-meeting-date'),
            decision: document.getElementById('decision'),
            notes: document.getElementById('notes'),
            agentName: document.getElementById('agent-name')
        };

        const contactInputs = {
            name: document.getElementById('contact-name'),
            surname: document.getElementById('contact-surname'),
            phone: document.getElementById('contact-phone'),
            email: document.getElementById('contact-email'),
            role: document.getElementById('contact-role')
        };

        // Etichette per export e anteprima
        const fieldLabels = {
            timestamp: 'Data Registrazione',
            agentName: 'Cognome Referente Commerciale',
            companyName: 'Nome Azienda',
            companyState: 'Stato/Regione',
            companyCity: 'Città',
            companyAddress: 'Indirizzo',
            division: 'Divisione',
            sector: 'Settore',
            typology: 'Tipologia',
            competitors: 'Concorrenti Citati',
            priceSensitivity: 'Sensibilità Prezzo',
            expectedVolume: 'Volumi Attesi',
            contactName: 'Nome Contatto',
            contactSurname: 'Cognome Contatto',
            contactPhone: 'Telefono Contatto',
            contactEmail: 'Email Contatto',
            contactRole: 'Ruolo Contatto',
            meetingType: 'Tipo Incontro',
            meetingSubject: 'Oggetto Incontro',
            meetingDate: 'Data Incontro',
            nextMeetingDate: 'Prossimo Incontro',
            decision: 'Decisione',
            notes: 'Note'
        };

        let currentPage = 1;
        let allVisits = []; // Array persistente delle visite salvate
        const pageTitles = ["Dati Azienda", "Dati Contatto", "Note e Agente"];
        
        // --- Gestione Storage ---
        const loadVisitsFromLocalStorage = () => {
            try {
                const storedVisits = localStorage.getItem('salesReportVisits');
                if (storedVisits) {
                    const parsed = JSON.parse(storedVisits);
                    // Migrazione per vecchi dati che non avevano l'array 'contacts'
                    allVisits = parsed.map(v => {
                        if (!v.contacts) {
                            // Converti il vecchio contatto singolo in array di 1
                            v.contacts = [{
                                name: v.contactName || '',
                                surname: v.contactSurname || '',
                                phone: v.contactPhone || '',
                                email: v.contactEmail || '',
                                role: v.contactRole || ''
                            }];
                        }
                        return v;
                    });
                }
            } catch (e) {
                console.error("Errore caricamento:", e);
                allVisits = [];
            }
        };

        const saveVisitsToLocalStorage = () => {
            localStorage.setItem('salesReportVisits', JSON.stringify(allVisits));
        };

        // --- Funzioni Multi-Contatto ---
        btnAddContact.addEventListener('click', () => {
            const name = contactInputs.name.value.trim();
            const surname = contactInputs.surname.value.trim();
            
            if (!name && !surname) {
                alert("Inserisci almeno Nome o Cognome.");
                return;
            }

            const newContact = {
                name: name,
                surname: surname,
                phone: contactInputs.phone.value.trim(),
                email: contactInputs.email.value.trim(),
                role: contactInputs.role.value.trim()
            };

            currentVisitContacts.push(newContact);
            updateContactsListUI();
            
            // Pulisci i campi contatto per il prossimo inserimento
            for (let key in contactInputs) contactInputs[key].value = '';
            contactInputs.name.focus();
        });

        const updateContactsListUI = () => {
            contactsListEl.innerHTML = '';
            if (currentVisitContacts.length === 0) {
                noContactsMsg.style.display = 'block';
                contactCountEl.textContent = '0';
            } else {
                noContactsMsg.style.display = 'none';
                contactCountEl.textContent = currentVisitContacts.length;
                
                currentVisitContacts.forEach((c, index) => {
                    const li = document.createElement('li');
                    li.className = "bg-white border border-gray-200 rounded p-2 flex justify-between items-center text-sm shadow-sm";
                    li.innerHTML = `
                        <div>
                            <span class="font-bold text-gray-700">${c.name} ${c.surname}</span>
                            <span class="text-gray-500 text-xs ml-2">${c.role}</span>
                        </div>
                        <button type="button" class="text-red-500 hover:text-red-700 font-bold px-2" onclick="removeContact(${index})">&times;</button>
                    `;
                    contactsListEl.appendChild(li);
                });
            }
        };

        // Espone la funzione rimuovi in global scope per l'onclick HTML
        window.removeContact = (index) => {
            currentVisitContacts.splice(index, 1);
            updateContactsListUI();
        };

        // --- UI & Navigazione ---
        const updateUI = () => {
            const count = allVisits.length;
            visitCountSpan.textContent = count;
            exportButton.disabled = count === 0;
            clearButton.disabled = count === 0;
            previewButton.disabled = count === 0;
            showPage(currentPage);
        };

        const showPage = (pageNumber) => {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page${pageNumber}`).classList.add('active');
            pageIndicator.textContent = `Pagina ${pageNumber} di 3: ${pageTitles[pageNumber - 1]}`;
            btnPrev.style.visibility = (pageNumber === 1) ? 'hidden' : 'visible';
            
            if (pageNumber === 3) {
                btnNext.textContent = 'Salva Visita';
                btnNext.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnNext.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btnNext.textContent = 'Avanti';
                btnNext.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnNext.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        };
        
        btnPrev.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });
        
        btnNext.addEventListener('click', () => {
            const companyNameInput = document.getElementById('company-name');
            const agentNameInput = document.getElementById('agent-name');

            if (currentPage === 1 && companyNameInput.value.trim() === '') {
                showInputError(companyNameInput, 'Il campo Nome è obbligatorio');
                return;
            }

            if (currentPage < 3) {
                currentPage++;
                showPage(currentPage);
            } else {
                if (agentNameInput.value.trim() === '') {
                    showInputError(agentNameInput, 'Cognome Referente è obbligatorio');
                    return;
                }
                saveVisit();
            }
        });

        const showInputError = (inputElement, message) => {
            inputElement.classList.add('input-error');
            const originalPlaceholder = inputElement.placeholder;
            inputElement.placeholder = message;
            inputElement.addEventListener('input', () => {
                inputElement.classList.remove('input-error');
                inputElement.placeholder = originalPlaceholder;
            }, { once: true });
        };

        // --- Salvataggio Visita ---
        const saveVisit = () => {
            // Raccogli dati azienda
            const visitData = {};
            for (const key in companyFields) {
                visitData[key] = companyFields[key].value.trim();
            }
            // Raccogli dati incontro e note
            for (const key in meetingFields) {
                if (key === 'meetingDate' || key === 'nextMeetingDate') {
                    visitData[key] = meetingFields[key].value;
                } else {
                    visitData[key] = meetingFields[key].value.trim();
                }
            }
            
            visitData.timestamp = new Date().toLocaleString('it-IT', { 
                year: '2-digit', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit' 
            });

            // Aggiungi contatti (se vuoto, aggiungine uno vuoto per generare almeno una riga nel CSV)
            if (currentVisitContacts.length === 0) {
                currentVisitContacts.push({ name: '', surname: '', phone: '', email: '', role: '' });
            }
            visitData.contacts = [...currentVisitContacts];

            allVisits.push(visitData);
            saveVisitsToLocalStorage();
            
            feedbackMessage.textContent = `Report per "${visitData.companyName}" salvato!`;
            setTimeout(() => feedbackMessage.textContent = '', 4000);
            
            // Reset completo
            reportForm.reset();
            currentVisitContacts = [];
            updateContactsListUI();
            currentPage = 1;
            updateUI();
        };

        // --- Export CSV con Fix Note e Multi-Riga ---
        const escapeCSV = (field) => {
            if (field === null || field === undefined) return '';
            let str = String(field);
            
            // FIX NOTE: Rimuovi tutti gli 'a capo' e sostituisci con ' - '
            // Questo previene che il CSV si spezzi su più righe fisiche
            str = str.replace(/[\r\n]+/g, " - ");

            // Gestione date YYYY-MM-DD -> DD/MM/YYYY
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [y, m, d] = str.split('-');
                return `${d}/${m}/${y}`;
            }
            
            // Escape virgolette
            if (str.includes(',') || str.includes('"')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        };

        exportButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            const headers = Object.values(fieldLabels);
            const csvRows = [headers.join(',')];
            
            allVisits.forEach(v => {
                // Per ogni visita, itera su tutti i contatti.
                // Genera una riga CSV per ogni contatto (denormalizzazione)
                v.contacts.forEach(contact => {
                    const rowData = {
                        ...v,
                        contactName: contact.name,
                        contactSurname: contact.surname,
                        contactPhone: contact.phone,
                        contactEmail: contact.email,
                        contactRole: contact.role
                    };

                    const rowString = Object.keys(fieldLabels).map(key => escapeCSV(rowData[key])).join(',');
                    csvRows.push(rowString);
                });
            });

            const csvContent = '\uFEFF' + csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.setAttribute('href', url);
            link.setAttribute('download', `report-visite-${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Altre Funzioni (Svuota, Anteprima, QR) ---
        clearButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            modal.classList.remove('hidden');
        });
        
        modalBtnCancel.addEventListener('click', () => modal.classList.add('hidden'));
        
        modalBtnConfirm.addEventListener('click', () => {
            allVisits = [];
            saveVisitsToLocalStorage();
            updateUI();
            modal.classList.add('hidden');
            feedbackMessage.textContent = 'Dati locali eliminati.';
            setTimeout(() => feedbackMessage.textContent = '', 4000);
        });

        // Scanner QR (Logica identica a v8)
        const stopQrScanner = () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.warn("Stop error", err));
            }
            qrModal.classList.add('hidden');
            qrScanFeedback.textContent = '';
        };

        btnScanQr.addEventListener('click', () => {
            qrModal.classList.remove('hidden');
            if (!html5QrCode) {
                try { html5QrCode = new Html5Qrcode("qr-reader"); } catch(e) {}
            }
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices.find(d => d.label.toLowerCase().includes('back'))?.id || devices[0].id;
                    html5QrCode.start(cameraId, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, onScanFailure);
                }
            }).catch(err => qrScanFeedback.textContent = "Errore fotocamera.");
        });
        
        btnCloseQr.addEventListener('click', stopQrScanner);

        const onScanSuccess = (decodedText) => {
            const success = parseVCard(decodedText) || parseJSON(decodedText);
            if (success) {
                feedbackMessage.textContent = "Dati QR importati!";
            } else {
                meetingFields.notes.value = (meetingFields.notes.value ? meetingFields.notes.value + ' - ' : '') + 'DATI QR: ' + decodedText;
                feedbackMessage.textContent = "QR copiato nelle Note!";
                currentPage = 3;
                showPage(3);
            }
            stopQrScanner();
            setTimeout(() => feedbackMessage.textContent = '', 4000);
        };
        
        const onScanFailure = (error) => {};

        // Funzioni Parser (Aggiornate per popolare i campi contatto TEMP invece di quelli diretti)
        // Dato che ora i contatti sono multipli, il QR riempie i campi di input "Aggiungi Contatto"
        const parseVCard = (text) => {
            if (!text.startsWith('BEGIN:VCARD')) return false;
            // ... logica vCard semplificata per brevità, identica a v8 ma punta a contactInputs ...
            let vCardData = {};
            text.split('\n').forEach(line => {
                if (line.includes(':')) {
                    let [key, ...value] = line.split(':');
                    vCardData[key.split(';')[0].trim().toUpperCase()] = value.join(':').trim();
                }
            });
            if (vCardData.ORG) companyFields.companyName.value = vCardData.ORG;
            // Popola campi contatto TEMP
            if (vCardData.N) {
                const [s, n] = vCardData.N.split(';');
                contactInputs.surname.value = s || '';
                contactInputs.name.value = n || '';
            }
            if (vCardData.TEL) contactInputs.phone.value = vCardData.TEL;
            if (vCardData.EMAIL) contactInputs.email.value = vCardData.EMAIL;
            if (vCardData.TITLE) contactInputs.role.value = vCardData.TITLE;
            return true;
        };
        
        const parseJSON = (text) => {
            try {
                const data = JSON.parse(text);
                const l = {}; 
                for(let k in data) l[k.toLowerCase()] = data[k];
                companyFields.companyName.value = l.company || l.azienda || companyFields.companyName.value;
                // Popola campi contatto TEMP
                contactInputs.name.value = l.name || l.nome || contactInputs.name.value;
                contactInputs.surname.value = l.surname || l.cognome || contactInputs.surname.value;
                contactInputs.email.value = l.email || contactInputs.email.value;
                contactInputs.phone.value = l.phone || contactInputs.phone.value;
                return true;
            } catch (e) { return false; }
        };

        // Anteprima semplice
        previewButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            let previewText = '';
            allVisits.forEach((visit, index) => {
                previewText += `--- VISITA ${index + 1} ---\n`;
                previewText += `Azienda: ${visit.companyName}\n`;
                previewText += `Contatti Incontrati: ${visit.contacts.length}\n`;
                visit.contacts.forEach(c => {
                    previewText += `  - ${c.name} ${c.surname} (${c.role})\n`;
                });
                previewText += `Note: ${visit.notes}\n\n`;
            });
            previewContent.textContent = previewText;
            previewBox.classList.remove('hidden');
            previewBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        btnClosePreview.addEventListener('click', () => {
            previewBox.classList.add('hidden');
            previewContent.textContent = '';
        });

        loadVisitsFromLocalStorage();
        updateUI();
    });
    </script>
</body>
</html>
