<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebApp Report Visite</title>
    
    <!-- ICONE PER LA HOME SCREEN -->
    <link rel="icon" href="Logo CERVE WebApp.jpg">
    <link rel="apple-touch-icon" href="Logo CERVE WebApp.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" xintegrity="sha512-rVFjOMM/c9f3MUPRguCInK7mS2jK0gG4Nq23rTf+vH/cNM/QnkhOEd1T8j1i/M2vG/vPjI31Zk+L8nL23rA2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icone Lucide (leggere e moderne) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-focus:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        #confirmation-modal.hidden, #qr-scanner-modal.hidden, #preview-box.hidden, #update-notes-modal.hidden {
            display: none;
        }
        .input-error {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px #fecaca;
        }
        #qr-reader {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 4px solid #3b82f6;
        }
        .export-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .export-group {
                grid-template-columns: 1fr 1fr;
            }
            .export-group-full {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        #preview-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: Consolas, 'Courier New', monospace;
            line-height: 1.6;
        }
        /* Accordion Styles */
        .accordion-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #f3f4f6;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 500px; /* Abbastanza alto per contenere le opzioni */
            transition: max-height 0.3s ease-in;
        }
        .arrow-icon {
            transition: transform 0.3s;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        /* Custom Select Wrapper per icona */
        .select-wrapper {
            position: relative;
        }
        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0; 
            height: 0; 
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #6b7280; /* Gray-500 */
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">Nuovo Report Visita</h1>
                <p id="page-indicator" class="text-gray-500 mt-2 font-medium">Pagina 1 di 3: Dati Azienda</p>
            </div>

            <form id="report-form" class="space-y-6">
                <!-- Pagina 1: Dati Azienda -->
                <div id="page1" class="page active">
                    
                    <!-- PULSANTE AGGIORNAMENTO NOTE (Spostato QUI dentro Page 1) -->
                    <div class="mb-4 flex justify-end">
                        <button type="button" id="btn-open-update-notes" class="text-sm text-blue-600 font-semibold hover:underline flex items-center gap-1">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                            Aggiorna Note Azienda Esistente
                        </button>
                    </div>

                    <div class="mb-6">
                        <button type="button" id="btn-scan-qr" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">
                            <i data-lucide="qr-code" class="w-5 h-5"></i>
                            Scansiona QR Code
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="company-name" class="block text-sm font-medium text-gray-600 mb-1">Nome Azienda</label>
                            <input type="text" id="company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-state" class="block text-sm font-medium text-gray-600 mb-1">Stato/Regione</label>
                            <input type="text" id="company-state" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-city" class="block text-sm font-medium text-gray-600 mb-1">Città</label>
                            <input type="text" id="company-city" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div class="md:col-span-2">
                            <label for="company-address" class="block text-sm font-medium text-gray-600 mb-1">Indirizzo</label>
                            <input type="text" id="company-address" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        
                        <!-- CAMPO DIVISIONE (Accordion Multi-select) -->
                        <div class="md:col-span-2 border border-gray-300 rounded-lg overflow-hidden">
                            <div class="accordion-header flex justify-between items-center p-3 bg-gray-50" onclick="toggleAccordion('division-content', 'division-arrow')">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Divisione</span>
                                    <p id="division-summary" class="text-xs text-gray-500 mt-1 truncate max-w-xs">Nessuna selezionata</p>
                                </div>
                                <i id="division-arrow" data-lucide="chevron-down" class="w-5 h-5 text-gray-500 arrow-icon"></i>
                            </div>
                            <div id="division-content" class="accordion-content bg-white px-3">
                                <div class="py-3 space-y-2" id="division-container">
                                    <!-- Checkbox generati via JS -->
                                </div>
                            </div>
                        </div>

                        <!-- CAMPO CANALE VENDITA (Accordion Multi-select + Custom) -->
                        <div class="md:col-span-2 border border-gray-300 rounded-lg overflow-hidden">
                            <div class="accordion-header flex justify-between items-center p-3 bg-gray-50" onclick="toggleAccordion('channel-content', 'channel-arrow')">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Canale di Vendita</span>
                                    <p id="channel-summary" class="text-xs text-gray-500 mt-1 truncate max-w-xs">Nessuna selezionata</p>
                                </div>
                                <i id="channel-arrow" data-lucide="chevron-down" class="w-5 h-5 text-gray-500 arrow-icon"></i>
                            </div>
                            <div id="channel-content" class="accordion-content bg-white px-3">
                                <div class="py-3 space-y-2" id="channel-container">
                                    <!-- Checkbox generati via JS -->
                                </div>
                                <div class="pb-3">
                                    <input type="text" id="custom-channel" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none input-focus" placeholder="Altro (specificare)...">
                                </div>
                            </div>
                        </div>

                        <!-- CAMPO SETTORE (Accordion Multi-select + Custom) -->
                        <div class="md:col-span-2 border border-gray-300 rounded-lg overflow-hidden">
                            <div class="accordion-header flex justify-between items-center p-3 bg-gray-50" onclick="toggleAccordion('sector-content', 'sector-arrow')">
                                <div>
                                    <span class="text-sm font-medium text-gray-700">Settore</span>
                                    <p id="sector-summary" class="text-xs text-gray-500 mt-1 truncate max-w-xs">Nessuna selezionata</p>
                                </div>
                                <i id="sector-arrow" data-lucide="chevron-down" class="w-5 h-5 text-gray-500 arrow-icon"></i>
                            </div>
                            <div id="sector-content" class="accordion-content bg-white px-3">
                                <div class="py-3 space-y-2" id="sector-container">
                                    <!-- Checkbox generati via JS -->
                                </div>
                                <div class="pb-3">
                                    <input type="text" id="custom-sector" class="w-full px-3 py-2 border border-gray-200 rounded text-sm focus:outline-none input-focus" placeholder="Altro (specificare)...">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="competitors" class="block text-sm font-medium text-gray-600 mb-1">Concorrenti Citati</label>
                            <input type="text" id="competitors" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         
                        <!-- Select Wrapper per icona a tendina -->
                        <div class="select-wrapper">
                            <label for="price-sensitivity" class="block text-sm font-medium text-gray-600 mb-1">Sensibilità al Prezzo</label>
                            <input list="price-sensitivity-list" id="price-sensitivity" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus cursor-pointer" placeholder="Seleziona...">
                            <datalist id="price-sensitivity-list">
                                <option value="Alta"></option>
                                <option value="Media"></option>
                                <option value="Bassa"></option>
                            </datalist>
                        </div>
                        
                        <div class="select-wrapper">
                            <label for="expected-volume" class="block text-sm font-medium text-gray-600 mb-1">Volumi Attesi</label>
                            <input list="expected-volume-list" id="expected-volume" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus cursor-pointer" placeholder="Seleziona...">
                            <datalist id="expected-volume-list">
                                <option value="Alti"></option>
                                <option value="Medi"></option>
                                <option value="Bassi"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 2: Dati Contatto -->
                <div id="page2" class="page">
                    <div class="mb-4 border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="user-plus" class="w-5 h-5"></i> Aggiungi Persona
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><input type="text" id="contact-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Nome"></div>
                            <div><input type="text" id="contact-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Cognome"></div>
                            <div><input type="tel" id="contact-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Telefono"></div>
                            <div><input type="email" id="contact-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Email"></div>
                            <div class="md:col-span-2"><input type="text" id="contact-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Ruolo"></div>
                        </div>
                        <button type="button" id="btn-add-contact" class="mt-3 w-full bg-indigo-50 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-100 transition-all border border-indigo-200 flex justify-center items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> Aggiungi alla Lista
                        </button>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Contatti Inseriti (<span id="contact-count">0</span>)</h3>
                        <ul id="contacts-list" class="space-y-2">
                            <li id="no-contacts-msg" class="text-sm text-gray-400 italic">Nessun contatto inserito.</li>
                        </ul>
                    </div>

                    <hr class="border-gray-200 my-6">

                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Dettagli Incontro</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="select-wrapper">
                            <label for="meeting-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo di Incontro</label>
                            <input list="meeting-type-list" id="meeting-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus cursor-pointer" placeholder="Seleziona...">
                            <datalist id="meeting-type-list">
                                <option value="Visita"></option><option value="Chiamata"></option><option value="Email"></option><option value="Fiera"></option><option value="Evento"></option>
                            </datalist>
                        </div>
                        <div class="md:col-span-2">
                            <label for="meeting-subject" class="block text-sm font-medium text-gray-600 mb-1">Oggetto Incontro</label>
                            <input type="text" id="meeting-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Data Incontro</label>
                            <input type="date" id="meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="next-meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Prossimo Incontro</label>
                            <input type="date" id="next-meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                    </div>
                </div>

                <!-- Pagina 3: Note e Cognome Agente -->
                <div id="page3" class="page">
                    <div class="space-y-6">
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-600 mb-1">Note</label>
                            <textarea id="notes" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Aggiungi qui le tue note strategiche..."></textarea>
                        </div>
                        <div>
                            <label for="agent-name" class="block text-sm font-medium text-gray-600 mb-1">Cognome Referente Commerciale</label>
                            <input type="text" id="agent-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Es. Rossi">
                        </div>
                    </div>
                </div>
            </form>

            <!-- Navigazione -->
            <div class="pt-6 border-t mt-6 flex justify-between items-center">
                <button id="btn-prev" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all shadow-md">Indietro</button>
                <button id="btn-next" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">Avanti</button>
            </div>
        </main>
        
        <!-- Anteprima -->
        <div id="preview-box" class="mt-8 bg-white rounded-xl shadow-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Anteprima Dati</h2>
                <button id="btn-close-preview" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
            </div>
            <pre id="preview-content" class="bg-gray-100 p-4 rounded-lg overflow-x-auto" style="max-height: 400px;"></pre>
        </div>

        <!-- Sezione Esportazione -->
        <div id="export-section" class="mt-8 bg-white rounded-xl shadow-lg p-6 text-center">
            <div id="feedback-message" class="mb-4 text-green-700 font-medium"></div>
            <p class="text-lg text-gray-800 mb-4">
                Hai <strong id="visit-count" class="text-blue-600">0</strong> visite salvate sul dispositivo.
            </p>
            
            <div class="export-group export-group-full">
                <button id="preview-data" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Vedi Anteprima
                </button>
                <button id="export-csv" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Esporta in CSV
                </button>
                <button id="clear-data" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Svuota Dati
                </button>
            </div>
        </div>
    </div>

    <!-- Modale Aggiorna Note -->
    <div id="update-notes-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Aggiorna Note Azienda</h3>
            <p class="text-sm text-gray-500 mb-4">Inserisci il nome dell'azienda già visitata e le nuove note da aggiungere.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nome Azienda (Esatto)</label>
                    <input type="text" id="update-company-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nuove Note</label>
                    <textarea id="update-notes-text" rows="5" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Il tuo Cognome</label>
                    <input type="text" id="update-agent-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="btn-cancel-update" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Annulla</button>
                <button id="btn-confirm-update" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Salva Aggiornamento</button>
            </div>
        </div>
    </div>

    <!-- Modale Conferma Eliminazione -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Conferma Eliminazione</h3>
            <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare <strong id="modal-visit-count">0</strong> visite salvate?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-btn-cancel" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Annulla</button>
                <button id="modal-btn-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Modale Scanner QR -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Inquadra il QR Code</h3>
            <div id="qr-reader" class="w-full"></div>
            <p id="qr-scan-feedback" class="text-center text-gray-600 mt-4"></p>
        </div>
        <button id="modal-btn-close-qr" class="bg-white text-gray-800 font-bold py-2 px-6 rounded-full hover:bg-gray-200 transition-all mt-6 shadow-lg">Chiudi Scanner</button>
    </div>

    <script>
        // Inizializza icone Lucide
        lucide.createIcons();

        // Espone toggleAccordion globalmente per onclick
        window.toggleAccordion = (contentId, arrowId) => {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            if (content.style.maxHeight) {
                content.style.maxHeight = null; // Chiudi
                arrow.classList.remove('rotate-180');
            } else {
                content.style.maxHeight = content.scrollHeight + "px"; // Apri
                arrow.classList.add('rotate-180');
            }
        };

    document.addEventListener('DOMContentLoaded', () => {
        // --- DATI PER MULTI-SELECT ---
        const divisions = ["VidiVi Italia", "VidiVi Estero", "Casalingo Italia", "Casalingo Estero", "B2B Italia", "B2B Estero"];
        const channels = ["GDS", "GDO", "Dettaglio", "Promozioni Aziendali", "Grossista", "Ho.Re.Ca.", "E-commerce", "Produttore"];
        const sectors = ["Vario", "Soft Drinks", "Cantina", "Birreria", "Bar", "Distilleria", "Gelateria"];

        // --- GENERAZIONE CHECKBOX ---
        const generateCheckboxes = (containerId, items, name, summaryId) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checkbox-item flex items-center gap-2';
                const id = `${name}-${item.replace(/[^a-zA-Z0-9]/g, '')}`; // ID sicuro
                div.innerHTML = `
                    <input type="checkbox" id="${id}" value="${item}" name="${name}" class="rounded text-blue-600 focus:ring-blue-500">
                    <label for="${id}" class="text-gray-700 text-sm cursor-pointer select-none flex-1">${item}</label>
                `;
                container.appendChild(div);
                
                // Listener per aggiornare il sommario
                const checkbox = div.querySelector('input');
                checkbox.addEventListener('change', () => updateSummary(name, summaryId));
            });
        };

        const updateSummary = (name, summaryId) => {
            const checked = Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
            const summaryEl = document.getElementById(summaryId);
            // Se c'è un campo custom (solo per channel e sector), aggiungilo
            let customVal = '';
            if (name === 'channel') customVal = document.getElementById('custom-channel').value.trim();
            if (name === 'sector') customVal = document.getElementById('custom-sector').value.trim();
            
            if (customVal) checked.push(customVal);

            if (checked.length > 0) {
                summaryEl.textContent = checked.join(', ');
                summaryEl.classList.remove('text-gray-500');
                summaryEl.classList.add('text-blue-600', 'font-medium');
            } else {
                summaryEl.textContent = 'Nessuna selezionata';
                summaryEl.classList.add('text-gray-500');
                summaryEl.classList.remove('text-blue-600', 'font-medium');
            }
        };

        generateCheckboxes('division-container', divisions, 'division', 'division-summary');
        generateCheckboxes('channel-container', channels, 'channel', 'channel-summary');
        generateCheckboxes('sector-container', sectors, 'sector', 'sector-summary');

        // Listener per input custom per aggiornare sommario live
        document.getElementById('custom-channel').addEventListener('input', () => updateSummary('channel', 'channel-summary'));
        document.getElementById('custom-sector').addEventListener('input', () => updateSummary('sector', 'sector-summary'));

        // --- RIFERIMENTI DOM ---
        const reportForm = document.getElementById('report-form');
        const pageIndicator = document.getElementById('page-indicator');
        const pages = document.querySelectorAll('.page');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const exportButton = document.getElementById('export-csv');
        const clearButton = document.getElementById('clear-data');
        const visitCountSpan = document.getElementById('visit-count');
        const feedbackMessage = document.getElementById('feedback-message');
        const companyNameInput = document.getElementById('company-name');
        const agentNameInput = document.getElementById('agent-name');

        // Custom inputs
        const customChannelInput = document.getElementById('custom-channel');
        const customSectorInput = document.getElementById('custom-sector');

        // Multi Contatto
        const btnAddContact = document.getElementById('btn-add-contact');
        const contactsListEl = document.getElementById('contacts-list');
        const noContactsMsg = document.getElementById('no-contacts-msg');
        const contactCountEl = document.getElementById('contact-count');
        
        // Modali
        const modalConfirm = document.getElementById('confirmation-modal');
        const modalVisitCount = document.getElementById('modal-visit-count');
        const modalBtnCancel = document.getElementById('modal-btn-cancel');
        const modalBtnConfirm = document.getElementById('modal-btn-confirm');
        
        const modalUpdate = document.getElementById('update-notes-modal');
        const btnOpenUpdate = document.getElementById('btn-open-update-notes');
        const btnCancelUpdate = document.getElementById('btn-cancel-update');
        const btnConfirmUpdate = document.getElementById('btn-confirm-update');

        // QR
        const btnScanQr = document.getElementById('btn-scan-qr');
        const qrModal = document.getElementById('qr-scanner-modal');
        const qrReaderDiv = document.getElementById('qr-reader');
        const qrScanFeedback = document.getElementById('qr-scan-feedback');
        const btnCloseQr = document.getElementById('modal-btn-close-qr');
        let html5QrCode = null;

        // Anteprima
        const previewButton = document.getElementById('preview-data');
        const previewBox = document.getElementById('preview-box');
        const previewContent = document.getElementById('preview-content');
        const btnClosePreview = document.getElementById('btn-close-preview');

        let currentPage = 1;
        let allVisits = [];
        let currentVisitContacts = [];
        const pageTitles = ["Dati Azienda", "Dati Contatto", "Note e Agente"];

        // --- MAPPIAMO I CAMPI (Esclusi Checkbox, Custom e Contatti) ---
        const companyFields = {
            companyName: document.getElementById('company-name'),
            companyState: document.getElementById('company-state'),
            companyCity: document.getElementById('company-city'),
            companyAddress: document.getElementById('company-address'),
            competitors: document.getElementById('competitors'),
            priceSensitivity: document.getElementById('price-sensitivity'),
            expectedVolume: document.getElementById('expected-volume')
        };

        const meetingFields = {
            meetingType: document.getElementById('meeting-type'),
            meetingSubject: document.getElementById('meeting-subject'),
            meetingDate: document.getElementById('meeting-date'),
            nextMeetingDate: document.getElementById('next-meeting-date'),
            notes: document.getElementById('notes'),
            agentName: document.getElementById('agent-name')
        };

        const contactInputs = {
            name: document.getElementById('contact-name'),
            surname: document.getElementById('contact-surname'),
            phone: document.getElementById('contact-phone'),
            email: document.getElementById('contact-email'),
            role: document.getElementById('contact-role')
        };

        // Etichette per Export
        const fieldLabels = {
            timestamp: 'Data Registrazione',
            agentName: 'Cognome Referente Commerciale',
            companyName: 'Nome Azienda',
            companyState: 'Stato/Regione',
            companyCity: 'Città',
            companyAddress: 'Indirizzo',
            division: 'Divisione',
            sector: 'Settore',
            channel: 'Canale di Vendita', 
            competitors: 'Concorrenti Citati',
            priceSensitivity: 'Sensibilità Prezzo',
            expectedVolume: 'Volumi Attesi',
            contactName: 'Nome Contatto',
            contactSurname: 'Cognome Contatto',
            contactPhone: 'Telefono Contatto',
            contactEmail: 'Email Contatto',
            contactRole: 'Ruolo Contatto',
            meetingType: 'Tipo Incontro',
            meetingSubject: 'Oggetto Incontro',
            meetingDate: 'Data Incontro',
            nextMeetingDate: 'Prossimo Incontro',
            notes: 'Note'
        };

        // --- STORAGE ---
        const loadVisits = () => {
            try {
                const data = localStorage.getItem('salesReportVisits');
                if (data) allVisits = JSON.parse(data);
            } catch (e) { allVisits = []; }
        };
        const saveVisits = () => localStorage.setItem('salesReportVisits', JSON.stringify(allVisits));

        // --- UTILS ---
        const getMultiSelectValue = (name, customInput) => {
            const checked = Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
            if (customInput && customInput.value.trim()) {
                checked.push(customInput.value.trim());
            }
            return checked.join('; ');
        };

        const showInputError = (el, msg) => {
            el.classList.add('input-error');
            el.placeholder = msg;
            el.addEventListener('input', () => {
                el.classList.remove('input-error');
            }, { once: true });
        };

        // --- NAVIGAZIONE ---
        const updateUI = () => {
            visitCountSpan.textContent = allVisits.length;
            const hasVisits = allVisits.length > 0;
            exportButton.disabled = !hasVisits;
            clearButton.disabled = !hasVisits;
            previewButton.disabled = !hasVisits;
            
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page${currentPage}`).classList.add('active');
            pageIndicator.textContent = `Pagina ${currentPage} di 3: ${pageTitles[currentPage - 1]}`;
            
            btnPrev.style.visibility = currentPage === 1 ? 'hidden' : 'visible';
            
            if (currentPage === 3) {
                btnNext.textContent = 'Salva Visita';
                btnNext.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnNext.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btnNext.textContent = 'Avanti';
                btnNext.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnNext.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        };

        btnPrev.addEventListener('click', () => { if(currentPage > 1) { currentPage--; updateUI(); } });
        btnNext.addEventListener('click', () => {
            if (currentPage === 1 && !companyNameInput.value.trim()) {
                showInputError(companyNameInput, "Nome obbligatorio"); return;
            }
            if (currentPage === 3) {
                if (!agentNameInput.value.trim()) {
                    showInputError(agentNameInput, "Cognome obbligatorio"); return;
                }
                saveVisit();
            } else {
                currentPage++; updateUI();
            }
        });

        // --- MULTI CONTATTO ---
        btnAddContact.addEventListener('click', () => {
            if (!contactInputs.name.value.trim() && !contactInputs.surname.value.trim()) {
                alert("Inserisci almeno un nome o cognome."); return;
            }
            currentVisitContacts.push({
                name: contactInputs.name.value.trim(),
                surname: contactInputs.surname.value.trim(),
                phone: contactInputs.phone.value.trim(),
                email: contactInputs.email.value.trim(),
                role: contactInputs.role.value.trim()
            });
            updateContactsUI();
            for (let k in contactInputs) contactInputs[k].value = '';
        });

        window.removeContact = (i) => { currentVisitContacts.splice(i, 1); updateContactsUI(); };

        const updateContactsUI = () => {
            contactsListEl.innerHTML = '';
            if (currentVisitContacts.length === 0) {
                noContactsMsg.style.display = 'block';
                contactCountEl.textContent = '0';
            } else {
                noContactsMsg.style.display = 'none';
                contactCountEl.textContent = currentVisitContacts.length;
                currentVisitContacts.forEach((c, i) => {
                    const li = document.createElement('li');
                    li.className = "bg-white border p-2 flex justify-between rounded text-sm";
                    li.innerHTML = `<span>${c.name} ${c.surname}</span><button onclick="removeContact(${i})" class="text-red-500 font-bold">&times;</button>`;
                    contactsListEl.appendChild(li);
                });
            }
        };

        // --- SALVATAGGIO VISITA ---
        const saveVisit = () => {
            const visit = {
                division: getMultiSelectValue('division', null),
                channel: getMultiSelectValue('channel', customChannelInput),
                sector: getMultiSelectValue('sector', customSectorInput),
                timestamp: new Date().toLocaleString('it-IT', { 
                    year: '2-digit', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                })
            };
            
            for (let k in companyFields) visit[k] = companyFields[k].value.trim();
            for (let k in meetingFields) {
                visit[k] = k.includes('Date') ? meetingFields[k].value : meetingFields[k].value.trim();
            }

            if (currentVisitContacts.length === 0) {
                currentVisitContacts.push({ name:'', surname:'', phone:'', email:'', role:'' });
            }
            visit.contacts = [...currentVisitContacts];

            allVisits.push(visit);
            saveVisits();
            
            feedbackMessage.textContent = "Visita Salvata!";
            setTimeout(() => feedbackMessage.textContent = '', 3000);
            
            reportForm.reset();
            // Reset manuale checkbox, custom inputs e sommari
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            customChannelInput.value = '';
            customSectorInput.value = '';
            ['division', 'channel', 'sector'].forEach(n => updateSummary(n, `${n}-summary`));
            
            currentVisitContacts = [];
            updateContactsUI();
            currentPage = 1;
            updateUI();
        };

        // --- AGGIORNAMENTO NOTE ---
        btnOpenUpdate.addEventListener('click', () => modalUpdate.classList.remove('hidden'));
        btnCancelUpdate.addEventListener('click', () => modalUpdate.classList.add('hidden'));
        
        btnConfirmUpdate.addEventListener('click', () => {
            const company = document.getElementById('update-company-name').value.trim();
            const notes = document.getElementById('update-notes-text').value.trim();
            const agent = document.getElementById('update-agent-name').value.trim();

            if (!company || !notes || !agent) {
                alert("Compila tutti i campi!"); return;
            }

            const updateEntry = {
                timestamp: new Date().toLocaleString('it-IT', { 
                    year: '2-digit', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                }),
                agentName: agent,
                companyName: company,
                notes: ">>> AGGIORNAMENTO NOTE: " + notes,
                contacts: [{name:'', surname:'', role:'', email:'', phone:''}],
                division: '', channel: '', sector: '', companyCity: '', companyAddress: '',
                companyState: '', competitors: '', priceSensitivity: '', expectedVolume: '',
                meetingType: '', meetingSubject: '', meetingDate: '', nextMeetingDate: ''
            };

            allVisits.push(updateEntry);
            saveVisits();
            updateUI();
            
            document.getElementById('update-company-name').value = '';
            document.getElementById('update-notes-text').value = '';
            modalUpdate.classList.add('hidden');
            feedbackMessage.textContent = "Aggiornamento Note Salvato!";
            setTimeout(() => feedbackMessage.textContent = '', 3000);
        });

        // --- EXPORT CSV ---
        const escapeCSV = (str) => {
            if (str === null || str === undefined) return '';
            str = String(str).replace(/[\r\n]+/g, " - "); // Fix Newlines
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) str = str.split('-').reverse().join('/'); // Fix Date
            if (str.includes(',') || str.includes('"') || str.includes(';')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        };

        exportButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            const headers = Object.values(fieldLabels);
            const csvRows = [headers.join(',')];

            allVisits.forEach(v => {
                v.contacts.forEach(c => {
                    const flatRow = { ...v, 
                        contactName: c.name, contactSurname: c.surname, 
                        contactPhone: c.phone, contactEmail: c.email, contactRole: c.role 
                    };
                    csvRows.push(Object.keys(fieldLabels).map(k => escapeCSV(flatRow[k])).join(','));
                });
            });

            const blob = new Blob(['\uFEFF' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `report-visite-${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        });

        // --- ANTEPRIMA ---
        previewButton.addEventListener('click', () => {
            let txt = '';
            allVisits.forEach((v, i) => {
                txt += `--- VISITA ${i+1} ---\nAZIENDA: ${v.companyName}\n`;
                if (v.notes.startsWith(">>>")) txt += `TIPO: ${v.notes}\n`; 
                else {
                    txt += `DIVISIONI: ${v.division}\nCANALE: ${v.channel}\nSETTORE: ${v.sector}\n`;
                    txt += `NOTE: ${v.notes}\n`;
                }
                txt += `\n`;
            });
            previewContent.textContent = txt;
            previewBox.classList.remove('hidden');
            previewBox.scrollIntoView({behavior: 'smooth'});
        });
        btnClosePreview.addEventListener('click', () => previewBox.classList.add('hidden'));

        // --- ALTRE FUNZIONI (QR, Svuota) ---
        clearButton.addEventListener('click', () => modalConfirm.classList.remove('hidden'));
        modalBtnCancel.addEventListener('click', () => modalConfirm.classList.add('hidden'));
        modalBtnConfirm.addEventListener('click', () => { allVisits=[]; saveVisits(); updateUI(); modalConfirm.classList.add('hidden'); });

        const onScanSuccess = (text) => {
            companyFields.companyName.value = text; 
            feedbackMessage.textContent = "QR Letto (Dati Grezzi inseriti in Nome)";
            stopQr();
        };
        const stopQr = () => { if(html5QrCode) html5QrCode.stop().catch(()=>{}); qrModal.classList.add('hidden'); };
        
        btnScanQr.addEventListener('click', () => {
            qrModal.classList.remove('hidden');
            if(!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10 }, onScanSuccess).catch(() => {});
        });
        btnCloseQr.addEventListener('click', stopQr);

        loadVisits();
        updateUI();
    });
    </script>
</body>
</html>
