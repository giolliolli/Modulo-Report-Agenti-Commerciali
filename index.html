YPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebApp Report Visite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libreria per creare file Excel (.xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-focus:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Stili per il modale di conferma */
        #confirmation-modal.hidden {
            display: none;
        }
        /* Stile per input obbligatorio non compilato */
        .input-error {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 2px #fecaca; /* red-200 */
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <main class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <div class="text-center mb-6 border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">Nuovo Report Visita</h1>
                <p id="page-indicator" class="text-gray-500 mt-2 font-medium">Pagina 1 di 3: Dati Azienda</p>
            </div>

            <form id="report-form" class="space-y-6">
                <!-- Pagina 1: Dati Azienda -->
                <div id="page1" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="company-name" class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="company-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-state" class="block text-sm font-medium text-gray-600 mb-1">Stato/Regione</label>
                            <input type="text" id="company-state" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="company-city" class="block text-sm font-medium text-gray-600 mb-1">Città</label>
                            <input type="text" id="company-city" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div class="md:col-span-2">
                            <label for="company-address" class="block text-sm font-medium text-gray-600 mb-1">Indirizzo</label>
                            <input type="text" id="company-address" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        
                        <!-- Campi con Datalist -->
                        <div>
                            <label for="division" class="block text-sm font-medium text-gray-600 mb-1">Divisione</label>
                            <input list="division-list" id="division" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="division-list">
                                <option value="VidiVi Italia"></option>
                                <option value="VidiVi Estero"></option>
                                <option value="Casalingo Italia"></option>
                                <option value="Casalingo Estero"></option>
                                <option value="B2B Italia"></option>
                                <option value="B2B Estero"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="sector" class="block text-sm font-medium text-gray-600 mb-1">Settore</label>
                            <input list="sector-list" id="sector" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="sector-list">
                                <option value="Vario"></option>
                                <option value="Soft Drinks"></option>
                                <option value="Cantina"></option>
                                <option value="Birreria"></option>
                                <option value="Bar"></option>
                                <option value="Distilleria"></option>
                                <option value="Gelateria"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="typology" class="block text-sm font-medium text-gray-600 mb-1">Tipologia</label>
                            <input list="typology-list" id="typology" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="typology-list">
                                <option value="GDS"></option>
                                <option value="GDO"></option>
                                <option value="Dettaglio"></option>
                                <option value="Promozioni Aziendali"></option>
                                <option value="Grossista"></option>
                                <option value="Ho.Re.Ca."></option>
                                <option value="E-commerce"></option>
                            </datalist>
                        </div>
                        <div>
                            <label for="competitors" class="block text-sm font-medium text-gray-600 mb-1">Concorrenti Citati</label>
                            <input type="text" id="competitors" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         <div>
                            <label for="price-sensitivity" class="block text-sm font-medium text-gray-600 mb-1">Sensibilità al Prezzo</label>
                            <input list="price-sensitivity-list" id="price-sensitivity" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="price-sensitivity-list">
                                <option value="Alta"></option>
                                <option value="Media"></option>
                                <option value="Bassa"></option>
                            </datalist>
                        </div>
                         <div>
                            <label for="expected-volume" class="block text-sm font-medium text-gray-600 mb-1">Volumi Attesi</label>
                            <input list="expected-volume-list" id="expected-volume" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="expected-volume-list">
                                <option value="Alti"></option>
                                <option value="Medi"></option>
                                <option value="Bassi"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 2: Dati Contatto -->
                <div id="page2" class="page">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="contact-name" class="block text-sm font-medium text-gray-600 mb-1">Nome</label>
                            <input type="text" id="contact-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-surname" class="block text-sm font-medium text-gray-600 mb-1">Cognome</label>
                            <input type="text" id="contact-surname" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-phone" class="block text-sm font-medium text-gray-600 mb-1">Telefono</label>
                            <input type="tel" id="contact-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-email" class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                            <input type="email" id="contact-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="contact-role" class="block text-sm font-medium text-gray-600 mb-1">Ruolo</label>
                            <input type="text" id="contact-role" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="meeting-type" class="block text-sm font-medium text-gray-600 mb-1">Tipo di Incontro</label>
                            <input list="meeting-type-list" id="meeting-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="meeting-type-list">
                                <option value="Visita"></option>
                                <option value="Chiamata"></option>
                                <option value="Email"></option>
                                <option value="Fiera"></option>
                                <option value="Evento"></option>
                            </datalist>
                        </div>
                        <div class="md:col-span-2">
                            <label for="meeting-subject" class="block text-sm font-medium text-gray-600 mb-1">Oggetto Incontro</label>
                            <input type="text" id="meeting-subject" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Data Incontro</label>
                            <input type="date" id="meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                        <div>
                            <label for="next-meeting-date" class="block text-sm font-medium text-gray-600 mb-1">Prossimo Incontro</label>
                            <input type="date" id="next-meeting-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                        </div>
                         <div class="md:col-span-2">
                            <label for="decision" class="block text-sm font-medium text-gray-600 mb-1">Decisione</label>
                            <input list="decision-list" id="decision" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus">
                            <datalist id="decision-list">
                                <option value="In Attesa"></option>
                                <option value="Follow-Up"></option>
                                <option value="Online Immediato"></option>
                                <option value="Opportunità"></option>
                                <option value="Richiede Campionatura"></option>
                            </datalist>
                        </div>
                    </div>
                </div>

                <!-- Pagina 3: Note e Cognome Agente -->
                <div id="page3" class="page">
                    <div class="space-y-6">
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-600 mb-1">Note</label>
                            <textarea id="notes" rows="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Aggiungi qui le tue note strategiche..."></textarea>
                        </div>
                        <!-- NUOVO CAMPO -->
                        <div>
                            <label for="agent-name" class="block text-sm font-medium text-gray-600 mb-1">Cognome Agente</label>
                            <input type="text" id="agent-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none input-focus" placeholder="Es. Rossi">
                        </div>
                    </div>
                </div>
            </form>

            <!-- Navigazione -->
            <div class="pt-6 border-t mt-6 flex justify-between items-center">
                <button id="btn-prev" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all shadow-md">Indietro</button>
                <button id="btn-next" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all shadow-md">Avanti</button>
            </div>
        </main>
        
        <!-- Sezione Esportazione -->
        <div id="export-section" class="mt-8 bg-white rounded-xl shadow-lg p-6 text-center">
            <div id="feedback-message" class="mb-4 text-green-700 font-medium"></div>
            <p class="text-lg text-gray-800 mb-4">
                Hai <strong id="visit-count" class="text-blue-600">0</strong> visite salvate sul dispositivo.
            </p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="export-excel" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Esporta Tutto in Excel
                </button>
                <button id="clear-data" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 transition-all shadow-md disabled:bg-gray-400" disabled>
                    Svuota Dati Locali
                </button>
            </div>
        </div>
    </div>

    <!-- Modale di Conferma Eliminazione -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Conferma Eliminazione</h3>
            <p class="text-gray-600 mb-6">Sei sicuro di voler eliminare <strong id="modal-visit-count">0</strong> visite salvate? L'operazione non è reversibile.</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-btn-cancel" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-all">Annulla</button>
                <button id="modal-btn-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all">Conferma ed Elimina</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Riferimenti agli elementi
        const reportForm = document.getElementById('report-form');
        const pageIndicator = document.getElementById('page-indicator');
        const pages = document.querySelectorAll('.page');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const exportButton = document.getElementById('export-excel'); // Modificato
        const clearButton = document.getElementById('clear-data');
        const visitCountSpan = document.getElementById('visit-count');
        const feedbackMessage = document.getElementById('feedback-message');
        const modal = document.getElementById('confirmation-modal');
        const modalVisitCount = document.getElementById('modal-visit-count');
        const modalBtnCancel = document.getElementById('modal-btn-cancel');
        const modalBtnConfirm = document.getElementById('modal-btn-confirm');
        
        // Input obbligatori
        const companyNameInput = document.getElementById('company-name');
        const agentNameInput = document.getElementById('agent-name');

        let currentPage = 1;
        let allVisits = [];
        const pageTitles = ["Dati Azienda", "Dati Contatto", "Note e Agente"];
        
        // --- Gestione Storage ---
        const loadVisitsFromLocalStorage = () => {
            const storedVisits = localStorage.getItem('salesReportVisits');
            if (storedVisits) {
                allVisits = JSON.parse(storedVisits);
            }
        };

        const saveVisitsToLocalStorage = () => {
            localStorage.setItem('salesReportVisits', JSON.stringify(allVisits));
        };

        // --- Funzione Utility per Feedback Visivo Errore ---
        const showInputError = (inputElement, message) => {
            inputElement.classList.add('input-error');
            const originalPlaceholder = inputElement.placeholder;
            inputElement.placeholder = message;
            
            inputElement.addEventListener('input', () => {
                inputElement.classList.remove('input-error');
                inputElement.placeholder = originalPlaceholder;
            }, { once: true });
        };
        
        // --- Aggiornamento UI ---
        const updateUI = () => {
            visitCountSpan.textContent = allVisits.length;
            exportButton.disabled = allVisits.length === 0;
            clearButton.disabled = allVisits.length === 0;
            showPage(currentPage);
        };

        const showPage = (pageNumber) => {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`page${pageNumber}`).classList.add('active');
            
            pageIndicator.textContent = `Pagina ${pageNumber} di 3: ${pageTitles[pageNumber - 1]}`;

            btnPrev.style.visibility = (pageNumber === 1) ? 'hidden' : 'visible';
            
            if (pageNumber === 3) {
                btnNext.textContent = 'Salva Visita';
                btnNext.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnNext.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btnNext.textContent = 'Avanti';
                btnNext.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnNext.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        };
        
        // --- Navigazione Pagine e Validazione ---
        btnPrev.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });
        
        btnNext.addEventListener('click', () => {
            // Validazione Pagina 1
            if (currentPage === 1 && companyNameInput.value.trim() === '') {
                showInputError(companyNameInput, 'Il campo Nome è obbligatorio');
                return;
            }

            if (currentPage < 3) {
                currentPage++;
                showPage(currentPage);
            } else {
                // Validazione Pagina 3 (Cognome Agente)
                if (agentNameInput.value.trim() === '') {
                    showInputError(agentNameInput, 'Il Cognome Agente è obbligatorio');
                    return;
                }
                saveVisit();
            }
        });

        // --- Logica di Salvataggio ---
        const saveVisit = () => {
            const visitData = {
                timestamp: new Date().toLocaleString('it-IT'),
                // Pagina 1
                companyName: companyNameInput.value.trim(),
                companyState: document.getElementById('company-state').value.trim(),
                companyCity: document.getElementById('company-city').value.trim(),
                companyAddress: document.getElementById('company-address').value.trim(),
                division: document.getElementById('division').value.trim(),
                sector: document.getElementById('sector').value.trim(),
                typology: document.getElementById('typology').value.trim(),
                competitors: document.getElementById('competitors').value.trim(),
                priceSensitivity: document.getElementById('price-sensitivity').value.trim(),
                expectedVolume: document.getElementById('expected-volume').value.trim(),
                // Pagina 2
                contactName: document.getElementById('contact-name').value.trim(),
                contactSurname: document.getElementById('contact-surname').value.trim(),
                contactPhone: document.getElementById('contact-phone').value.trim(),
                contactEmail: document.getElementById('contact-email').value.trim(),
                contactRole: document.getElementById('contact-role').value.trim(),
                meetingType: document.getElementById('meeting-type').value.trim(),
                meetingSubject: document.getElementById('meeting-subject').value.trim(),
                meetingDate: document.getElementById('meeting-date').value,
                nextMeetingDate: document.getElementById('next-meeting-date').value,
                decision: document.getElementById('decision').value.trim(),
                // Pagina 3
                notes: document.getElementById('notes').value.trim(),
                agentName: agentNameInput.value.trim() // Nuovo campo
            };

            allVisits.push(visitData);
            saveVisitsToLocalStorage();
            
            feedbackMessage.textContent = `Report per "${visitData.companyName}" salvato!`;
            setTimeout(() => feedbackMessage.textContent = '', 4000);
            
            reportForm.reset();
            currentPage = 1;
            updateUI();
        };

        // --- NUOVA LOGICA DI ESPORTAZIONE (EXCEL) ---
        exportButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;

            // 1. Dati per il foglio "Anagrafica"
            const anagraficaHeaders = [
                "Agente Compilatore", "Ragione Sociale", "Indirizzo", "Luogo", "Regione/Stato", 
                "Settore", "Divisione", "Tipologia", 
                "Nome", "Cognome", "Contatto Telefonico", "Email", "Ruolo"
            ];
            const anagraficaData = allVisits.map(v => [
                v.agentName, v.companyName, v.companyAddress, v.companyCity, v.companyState,
                v.sector, v.division, v.typology,
                v.contactName, v.contactSurname, v.contactPhone, v.contactEmail, v.contactRole
            ]);
            const ws_anagrafica = XLSX.utils.aoa_to_sheet([anagraficaHeaders, ...anagraficaData]);

            // 2. Dati per il foglio "Info Strategiche"
            const infoHeaders = [
                "Agente Compilatore", "Ragione Sociale", // Aggiunti per riferimento
                "Data Incontro", "Tipo di incontro", "Oggetto dell'Incontro", "Outcome/Decisione", 
                "Prossimo Incontro", "Concorrenti Citati", "Sensibilità al Prezzo", "Volumi Attesi", "Note Strategiche"
            ];
            const infoData = allVisits.map(v => [
                v.agentName, v.companyName,
                v.meetingDate, v.meetingType, v.meetingSubject, v.decision,
                v.nextMeetingDate, v.competitors, v.priceSensitivity, v.expectedVolume, v.notes
            ]);
            const ws_info = XLSX.utils.aoa_to_sheet([infoHeaders, ...infoData]);

            // 3. Creazione del Workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws_anagrafica, "Anagrafica");
            XLSX.utils.book_append_sheet(wb, ws_info, "Info Strategiche");

            // 4. Download del file
            const date = new Date().toISOString().slice(0, 10);
            const fileName = `report-visite-${v.agentName || 'agenti'}-${date}.xlsx`;
            XLSX.writeFile(wb, fileName);
        });
        
        // --- Logica Svuota Dati ---
        clearButton.addEventListener('click', () => {
            if (allVisits.length === 0) return;
            modalVisitCount.textContent = allVisits.length;
            modal.classList.remove('hidden');
        });

        modalBtnCancel.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        modalBtnConfirm.addEventListener('click', () => {
            allVisits = [];
            saveVisitsToLocalStorage();
            updateUI();
            modal.classList.add('hidden');
            
            feedbackMessage.textContent = 'Dati locali eliminati con successo.';
            setTimeout(() => feedbackMessage.textContent = '', 4000);
        });

        // --- Inizializzazione ---
        loadVisitsFromLocalStorage();
        updateUI();
    });
    </script>
</body>
</html>
